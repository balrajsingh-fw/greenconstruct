{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Create New Sustainability Project - Step 1: Carbon Tool</h2>

  <form method="POST">
    {% csrf_token %}
    {{ formset.management_form }}

    <!-- Project Name -->
    <div class="form-group mb-3">
        <label for="building_type"><strong>Building Type</strong></label>
      <select id="building_type" name="building_type" class="form-control" required>
        <option value="" disabled selected>Select a building type</option>
        {% for btype in building_types %}
          <option value="{{ btype.key }}">{{ btype.label }}</option>
        {% endfor %}
      </select>
      <label for="name"><strong>Project Name</strong></label>
      <input type="text" id="name" name="name" class="form-control" required />
    </div>
    <div class="form-group mb-3">
  <label for="leed_certification"><strong>LEED Certification</strong></label>
  <select id="leed_certification" name="leed_certification" class="form-control" required>
    <option value="">-- Select LEED Type --</option>
    <option value="LEED BD+C">LEED BD+C (Building Design and Construction)</option>
    <option value="LEED ID+C">LEED ID+C (Interior Design and Construction)</option>
    <option value="LEED O+M">LEED O+M (Operations and Maintenance)</option>
    <option value="LEED ND">LEED ND (Neighborhood Development)</option>
    <option value="LEED Homes">LEED Homes</option>
    <option value="LEED Cities and Communities">LEED Cities and Communities</option>
  </select>
</div>

<div class="form-group mb-3">
  <label for="well_certification"><strong>WELL Certification</strong></label>
  <select id="well_certification" name="well_certification" class="form-control" required>
    <option value="">-- Select WELL Type --</option>
    <option value="WELL v2">WELL Building Standard (WELL v2)</option>
    <option value="WELL Core">WELL Core</option>
    <option value="WELL Interiors">WELL Interiors</option>
    <option value="WELL Community">WELL Community</option>
    <option value="WELL Portfolio">WELL Portfolio</option>
  </select>
</div>

    <!-- Material Formset -->
    <div id="formset-container">
      {% for form in formset %}
        <div class="border p-3 mb-3 rounded shadow-sm bg-light">
          <div class="form-group">
            {{ form.material.label_tag }} {{ form.material }}
          </div>
          <div class="form-group">
            {{ form.quantity.label_tag }} {{ form.quantity }}
          </div>
        </div>
      {% endfor %}
    </div>

    <button type="button" class="btn btn-secondary mb-3" onclick="addForm()">âž• Add Material</button><br>

    <!-- Hidden inputs to hold lat/lng/city/country -->
    <input type="hidden" id="id_latitude" name="latitude" />
    <input type="hidden" id="id_longitude" name="longitude" />
    <input type="hidden" id="id_city" name="city" />
    <input type="hidden" id="id_country" name="country" />

    <!-- Optional visible address display -->
    <div class="form-group">
      <label for="id_address_display"><strong>Selected Location</strong></label>
      <input type="text" id="id_address_display" class="form-control" readonly>
    </div>

    <!-- Map Container -->
    <div id="map" style="height: 400px;" class="my-3"></div>

    <button type="submit" class="btn btn-primary">Create Project & Continue</button>
  </form>
</div>

<script>
  function addForm() {
    const container = document.getElementById('formset-container');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    const currentFormCount = parseInt(totalForms.value);
    const emptyFormHtml = container.children[0].outerHTML.replace(/form-0/g, `form-${currentFormCount}`);
    container.insertAdjacentHTML('beforeend', emptyFormHtml);
    totalForms.value = currentFormCount + 1;
  }

  const defaultLat = 20.0;
  const defaultLng = 77.0;

  const map = L.map('map').setView([defaultLat, defaultLng], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  }).addTo(map);

  let marker;

  function onMapClick(e) {
    const lat = e.latlng.lat.toFixed(6);
    const lng = e.latlng.lng.toFixed(6);

    document.getElementById('id_latitude').value = lat;
    document.getElementById('id_longitude').value = lng;

    if (marker) {
      map.removeLayer(marker);
    }

    marker = L.marker([lat, lng]).addTo(map);

    // Reverse geocode
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
      .then(response => response.json())
      .then(data => {
        const address = data.address || {};
        const city = address.city || address.town || address.village || '';
        const country = address.country || '';
        const display = data.display_name || `${city}, ${country}`;

        document.getElementById('id_city').value = city;
        document.getElementById('id_country').value = country;
        document.getElementById('id_address_display').value = display;

        marker.bindPopup(`<strong>${display}</strong>`).openPopup();
      })
      .catch(error => {
        console.error('Reverse geocoding failed:', error);
        marker.bindPopup("Location selected").openPopup();
      });
  }

  map.on('click', onMapClick);
</script>
{% endblock %}
