{% extends 'base.html' %}
{% block content %}
<!-- LEED Section -->
  <div class="card-header bg-light">
    <h5 class="mb-0">LEED Certification Overview</h5>
  </div>
  <div class="card-body">

    <!-- Category-specific content blocks -->
    <div id="leed-category-blocks">
        <div class="category-block" id="category-IP" style="display: none;">
         {% include 'projects/leed_category/category_ip.html' %}
        </div>

        <div class="category-block" id="category-LT" style="display: none;">
        {% include 'projects/leed_category/category_lt.html' %}
        </div>

      <div class="category-block" id="category-SS" style="display: none;">
        {% include 'projects/leed_category/category_ss.html' %}
      </div>

      <div class="category-block" id="category-WE" style="display: none;">
        {% include 'projects/leed_category/category_we.html' %}
      </div>

      <div class="category-block" id="category-EA" style="display: none;">
        {% include 'projects/leed_category/category_ea.html' %}
      </div>

      <div class="category-block" id="category-MR" style="display: none;">
        {% include 'projects/leed_category/category_mr.html' %}
      </div>

      <div class="category-block" id="category-EQ" style="display: none;">
        {% include 'projects/leed_category/category_eq.html' %}
      </div>

      <div class="category-block" id="category-IN" style="display: none;">
        {% include 'projects/leed_category/category_in.html' %}
      </div>

      <div class="category-block" id="category-RP" style="display: none;">
        {% include 'projects/leed_category/category_rp.html' %}
      </div>

      <div class="category-block" id="category-ER" style="display: none;">
        {% include 'projects/leed_category/category_er.html' %}
      </div>

      <div class="category-block" id="category-Admin" style="display: none;">
        {% include 'projects/leed_category/category_gi.html' %}
      </div>
    </div>
  </div>

<!-- JavaScript for toggling blocks -->
<script>
  document.getElementById("leed-category-select").addEventListener("change", function () {
    // Hide all category blocks
    const blocks = document.querySelectorAll("#leed-category-blocks .category-block");
    blocks.forEach(block => block.style.display = "none");

    // Show the selected category block
    const selected = this.value;
    const selectedBlock = document.getElementById(`category-${selected}`);
    if (selectedBlock) {
      selectedBlock.style.display = "block";
    }
  });
</script>

<!--Documents upload JS-->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const submitUrl = "{% url 'submit_leed_docs' %}";
  const projectId = "{{ project.id }}";  // Ensure `project` is passed in context

  document.querySelectorAll('.show-add-document-form').forEach(button => {
    button.addEventListener('click', () => {
      const section = button.dataset.section;
      document.getElementById(`${section}-upload-document-container`).style.display = 'block';
      button.style.display = 'none';
    });
  });

  document.querySelectorAll('.close-upload-document-form').forEach(button => {
    button.addEventListener('click', () => {
      const form = button.closest('.upload-document-container');
      form.style.display = 'none';
      const section = form.id.replace('-upload-document-container', '');
      document.querySelector(`[data-section="${section}"]`).style.display = 'inline-block';
    });
  });

  document.querySelectorAll('.document-upload-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const section = form.dataset.section;
      const list = document.getElementById(`${section}-document-list`);
      const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;
      const btn = form.querySelector('button[type=submit]');
      const originalText = btn.innerHTML;

      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
      btn.disabled = true;

      const formData = new FormData(form);
      formData.append('action', 'upload_document');
      formData.append('project_id', projectId);

      try {
        const res = await fetch(submitUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrf },
          body: formData,
        });

        const result = await res.json();
        if (result.status === 'success') {
          const row = document.createElement('tr');
          row.dataset.id = result.document_id;
          row.innerHTML = `
            <td>${result.document_id}</td>
            <td>${result.title}</td>
            <td><a href="${result.file_url}" target="_blank">View File</a></td>
            <td><button class="btn btn-danger btn-sm remove-document-btn">Remove</button></td>`;
          list.appendChild(row);
          form.reset();
        } else {
          alert(result.message || 'Upload failed.');
        }
      } catch (err) {
        console.error(err);
        alert('Upload error. Try again.');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    });
  });

  document.querySelectorAll('tbody').forEach(tbody => {
    tbody.addEventListener('click', async e => {
      if (e.target.classList.contains('remove-document-btn')) {
        const row = e.target.closest('tr');
        const docId = row.dataset.id;
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const res = await fetch(submitUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf,
          },
          body: JSON.stringify({
            action: 'remove_document',
            document_id: docId,
            project_id: projectId
          }),
        });

        const result = await res.json();
        if (result.status === 'success') {
          row.remove();
        } else {
          alert(result.message || 'Delete failed.');
        }
      }
    });
  });
});
</script>
{% endblock %}

