{% extends "base.html" %}
{% block content %}

<style>
        :root {
            --primary-green: #28a745;
            --secondary-green: #20c997;
            --accent-blue: #007bff;
            --warning-orange: #fd7e14;
            --danger-red: #dc3545;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: white;
            border-radius: 20px;
            margin: 2rem auto;
            max-width: 1400px;
            box-shadow: var(--hover-shadow);
            overflow: hidden;
        }

        .header-section {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: white;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateX(0) translateY(0); }
            100% { transform: translateX(-100px) translateY(-100px); }
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .project-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .project-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .download-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .download-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .content-section {
            padding: 2rem;
        }

        .certification-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .certification-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .certification-level {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .insight-card {
            border: none;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .insight-header {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #6610f2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0;
        }

        .insight-header h5 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-body {
            background: var(--light-bg);
            padding: 1.5rem;
        }

        .score-badge {
            background: var(--primary-green);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .reasons-list {
            list-style: none;
            padding: 0;
        }

        .reasons-list li {
            background: white;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            border-left: 4px solid var(--primary-green);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            padding-left: 3rem;
        }

        .reasons-list li::before {
            content: 'âœ“';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-green);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: var(--card-shadow);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }

        .tabs-container {
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 50px;
            margin-right: 10px;
            padding: 12px 24px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(45deg, var(--primary-green), #1e5f42);
            color: white;
            box-shadow: var(--card-shadow);
        }

        .alert-custom {
            border-radius: 16px;
            border: none;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 5px solid var(--warning-orange);
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                border-radius: 15px;
            }

            .header-section {
                padding: 1.5rem;
            }

            .project-title {
                font-size: 2rem;
            }

            .content-section {
                padding: 1rem;
            }

            .certification-level {
                font-size: 2rem;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-green);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        .back-button {
            background: white;
            color: var(--accent-blue);
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-button:hover {
            background: var(--light-bg);
            color: #475569;
            transform: translateX(-2px);
        }
</style>

<div class="main-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-content">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="project-title">
                        <i class="fas fa-leaf me-3"></i>
                        LEED Analysis Dashboard
                    </h1>
                    <p class="project-subtitle">
                        <i class="fas fa-building me-2"></i>
                        Project: {{project.name}}
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a class="btn download-btn" href="/download-leed-scorecard/{{ project.id }}">
                        <i class="fas fa-download me-2"></i>
                        Download Scorecard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="content-section">
        <!-- Certification Status -->
        <div class="certification-card fade-in">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">
                        <i class="fas fa-certificate me-2"></i>
                        LEED Certification Status for {{project.leed_certification}}
                    </h4>
                    <div class="certification-level">{{project.leed_graph_metrics.sustainability_recommendation_score}}</div>
                    <p class="mb-0 mt-2 opacity-75">{{project.leed_graph_metrics.sustainability_recommendation_grade}}</p>
                </div>
                <div class="col-md-4 text-center">
                    <div style="font-size: 4rem; opacity: 0.7;">
                        <i class="fas fa-award"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-grid fade-in">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-cloud"></i>
                </div>
                <div class="stat-value">{{ total_emission }}</div>
                <div class="stat-label">kg COâ‚‚ Emissions</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-recycle"></i>
                </div>
                <div class="stat-value">{{project.waste_data.waste_factor}}</div>
                <div class="stat-label">Waste Factor</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="stat-value">{{project.design_data.energy_budget}} KW/h</div>
                <div class="stat-label">Energy Budget</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-value">{{project.leed_graph_metrics.sustainability_recommendation_score}}</div>
                <div class="stat-label">LEED Score</div>
            </div>
        </div>

        <!-- LEED Insights -->
        <div id="leedInsightStructured" class="fade-in">
            <!-- Current Scenario -->
            <div class="insight-card">
                <div class="insight-header">
                    <h5>
                        <i class="fas fa-chart-line"></i>
                        Current Scenario Analysis
                    </h5>
                </div>
                <div class="insight-body">
                    <div class="score-badge">Score: {{ project.leed_certification_insight.current_scenario.score }}/110</div>
                    <ul class="reasons-list">
                        {% for i in project.leed_certification_insight.current_scenario.reasons %}
                        <li>{{ i }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <!-- Suggestions -->
            <div class="insight-card">
                <div class="insight-header" style="background: linear-gradient(135deg, var(--secondary-green) 0%, var(--primary-green) 100%);">
                    <h5>
                        <i class="fas fa-lightbulb"></i>
                        Improvement Recommendations
                    </h5>
                </div>
                <div class="insight-body">
                    <div class="score-badge" style="background: var(--secondary-green);">Potential Score: {{ project.leed_certification_insight.suggestion.score }}/100</div>
                    <ul class="reasons-list">
                        {% for i in project.leed_certification_insight.suggestion.reasons %}
                        <li>{{ i }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Charts Section with Tabs -->
        <div class="tabs-container">
            <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast-panel" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Trend Forecast
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics-panel" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Current Metrics
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content" id="chartTabContent">
            <!-- Forecast Chart -->
            <div class="tab-pane fade show active" id="forecast-panel" role="tabpanel">
                <div class="chart-container">
                    <h4 class="chart-title">
                        <i class="fas fa-chart-line text-primary"></i>
                        Sustainability Trends Forecast
                    </h4>
                    <div class="chart-wrapper">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Metrics Chart -->
            <div class="tab-pane fade" id="metrics-panel" role="tabpanel">
                <div class="chart-container">
                    <h4 class="chart-title">
                        <i class="fas fa-chart-bar text-success"></i>
                        Current Performance Metrics
                    </h4>
                    <div class="chart-wrapper">
                        <canvas id="metricsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Back Button -->
<div class="mb-4">
    <a href="{% url 'project_step' project.id project.current_step %}" class="back-button">
        <i class="fas fa-arrow-left"></i>
        Back to Project
    </a>
</div>

{{ project.leed_combined_forecasting|json_script:"forecast-data" }}
{{ project.leed_graph_metrics|json_script:"metrics-data" }}

<!-- External Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get data from Django JSON scripts
    const forecastDataElement = document.getElementById('forecast-data');
    const metricsDataElement = document.getElementById('metrics-data');

    let forecastData = {};
    let metrics = {};

    try {
        forecastData = forecastDataElement ? JSON.parse(forecastDataElement.textContent) : {};
        metrics = metricsDataElement ? JSON.parse(metricsDataElement.textContent) : {};
    } catch (e) {
        console.error('Error parsing JSON data:', e);
        // Fallback sample data
        forecastData = {
            carbon_emission_trend: [
                { year: '2024', emission: 1200 },
                { year: '2025', emission: 1150 },
                { year: '2026', emission: 1100 }
            ],
            waste_trend: [
                { year: '2024', waste: 800 },
                { year: '2025', waste: 750 },
                { year: '2026', waste: 700 }
            ],
            energy_efficiency_trend: [
                { year: '2024', score: 75 },
                { year: '2025', score: 80 },
                { year: '2026', score: 85 }
            ]
        };
        metrics = {
            total_carbon_emission: 1200,
            predicted_waste_kg: 800,
            energy_efficiency_score: 75,
            sustainability_recommendation_score: 85,
            sustainability_recommendation_grade: 'A'
        };
    }

    let forecastChart = null;
    let metricsChart = null;

    function initializeForecastChart() {
        const forecastCtx = document.getElementById('forecastChart');
        if (!forecastCtx) return;

        // Destroy existing chart if it exists
        if (forecastChart) {
            forecastChart.destroy();
        }

        forecastChart = new Chart(forecastCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: forecastData.carbon_emission_trend ? forecastData.carbon_emission_trend.map(d => d.year) : ['2024', '2025', '2026'],
                datasets: [
                    {
                        label: 'Carbon Emissions (kg COâ‚‚)',
                        data: forecastData.carbon_emission_trend ? forecastData.carbon_emission_trend.map(d => d.emission) : [1200, 1150, 1100],
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54,162,235,0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#36A2EB',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Waste (kg)',
                        data: forecastData.waste_trend ? forecastData.waste_trend.map(d => d.waste) : [800, 750, 700],
                        borderColor: '#FF6384',
                        backgroundColor: 'rgba(255,99,132,0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#FF6384',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Energy Efficiency (%)',
                        data: forecastData.energy_efficiency_trend ? forecastData.energy_efficiency_trend.map(d => d.score) : [75, 80, 85],
                        borderColor: '#4BC0C0',
                        backgroundColor: 'rgba(75,192,192,0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#4BC0C0',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255,255,255,0.2)',
                        borderWidth: 1,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function initializeMetricsChart() {
        const metricsCtx = document.getElementById('metricsChart');
        if (!metricsCtx) return;

        // Destroy existing chart if it exists
        if (metricsChart) {
            metricsChart.destroy();
        }

        const totalCarbon = metrics.total_carbon_emission || 1200;
        const totalWaste = metrics.predicted_waste_kg || 800;
        const energyEfficiency = metrics.energy_efficiency_score || 75;
        const wellScore = metrics.sustainability_recommendation_score || 85;

        metricsChart = new Chart(metricsCtx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: [
                    'Carbon Emissions',
                    'Waste Generation',
                    'Energy Efficiency',
                    'LEED Score'
                ],
                datasets: [{
                    data: [totalCarbon, totalWaste, energyEfficiency, wellScore],
                    backgroundColor: [
                        '#FF6B6B',
                        '#4ECDC4',
                        '#45B7D1',
                        '#96CEB4'
                    ],
                    borderColor: [
                        '#FF5252',
                        '#26A69A',
                        '#2196F3',
                        '#66BB6A'
                    ],
                    borderWidth: 3,
                    hoverOffset: 15,
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                size: 14,
                                weight: '600'
                            },
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percent = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: ${value} (${percent}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor[i],
                                        pointStyle: 'circle'
                                    };
                                });
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderColor: 'rgba(255,255,255,0.2)',
                        borderWidth: 1,
                        cornerRadius: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label;
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);

                                let unit = '';
                                let grade = '';

                                switch(label) {
                                    case 'Carbon Emissions':
                                        unit = ' kg COâ‚‚';
                                        break;
                                    case 'Waste Generation':
                                        unit = ' kg';
                                        break;
                                    case 'Energy Efficiency':
                                        unit = '%';
                                        break;
                                    case 'LEED Score':
                                        unit = ' points';
                                        grade = ` (Grade: ${metrics.sustainability_recommendation_grade || 'A'})`;
                                        break;
                                }

                                return `${label}: ${value}${unit} (${percentage}%)${grade}`;
                            }
                        }
                    }
                },
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1500,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }

    // Initialize charts
    function initializeCharts() {
        setTimeout(() => {
            initializeForecastChart();
            initializeMetricsChart();
        }, 100);
    }

    // Initialize charts on page load
    initializeCharts();

    // Handle tab switching
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target');

            setTimeout(() => {
                if (targetId === '#forecast-panel') {
                    initializeForecastChart();
                } else if (targetId === '#metrics-panel') {
                    initializeMetricsChart();
                }
            }, 100);
        });
    });

    // Fade-in animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.fade-in').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'all 0.6s ease';
        observer.observe(el);
    });

    // Smooth scrolling
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        });
    });
});
</script>

{% endblock %}